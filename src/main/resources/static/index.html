<!DOCTYPE html>
<html>
<head>
    <title>Scrum Poker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="container">
    <h1 class="title pulse">Scrum Poker</h1>

    <!-- Initial buttons -->
    <div id="initial-buttons" class="card fade-in">
        <button class="btn btn-primary" onclick="showCreateRoom()">
            <span>🎯</span> Create Room
        </button>
        <button class="btn btn-outline" onclick="showJoinRoom()">
            <span>🚪</span> Join Room
        </button>
    </div>

    <!-- Create room form -->
    <div id="create-room-form" class="card" style="display:none;">
        <h2 style="margin-bottom: 1.5rem; color: var(--text-primary); font-weight: 600;">Create New Room</h2>
        <div class="input-group">
            <label class="input-label" for="create-username">Your Name</label>
            <input id="create-username" class="input" placeholder="Enter your name" autocomplete="off" />
        </div>
        <div class="form-buttons">
            <button class="btn btn-primary" onclick="createRoom()">
                <span>✨</span> Create Room
            </button>
            <button class="btn btn-secondary" onclick="backToInitial()">Cancel</button>
        </div>
    </div>

    <!-- Join room form -->
    <div id="join-room-form" class="card" style="display:none;">
        <h2 style="margin-bottom: 1.5rem; color: var(--text-primary); font-weight: 600;">Join Existing Room</h2>
        <div class="input-group">
            <label class="input-label" for="join-username">Your Name</label>
            <input id="join-username" class="input" placeholder="Enter your name" autocomplete="off" />
        </div>
        <div class="input-group">
            <label class="input-label" for="join-roomId">Room ID</label>
            <input id="join-roomId" class="input" placeholder="Enter room ID" autocomplete="off" style="text-transform: uppercase;" />
        </div>
        <div class="form-buttons">
            <button class="btn btn-primary" onclick="joinRoom()">
                <span>🎯</span> Join Room
            </button>
            <button class="btn btn-secondary" onclick="backToInitial()">Cancel</button>
        </div>
    </div>

    <!-- Poker area -->
    <div id="poker-area" class="poker-section" style="display:none;">
        <div class="card fade-in">
            <div class="room-header">
                <span>Room</span>
                <span class="room-id" id="room-name"></span>
            </div>

            <div class="controls-section">
                <h3>Choose Your Estimate</h3>
                <div id="vote-buttons" class="vote-buttons"></div>

                <div class="action-buttons">
                    <button id="reveal-btn" class="btn btn-primary" onclick="reveal()" style="display:none;">
                        <span>👁️</span> Reveal Cards
                    </button>
                    <button id="reset-btn" class="btn btn-secondary" onclick="reset()" style="display:none;">
                        <span>🔄</span> New Round
                    </button>
                    <button id="leave-btn" class="btn btn-outline" onclick="leaveRoom()">
                        <span>🚪</span> Leave Room
                    </button>
                </div>
            </div>

            <div class="participants-section">
                <div class="participant-count">
                    Team Members (<span id="total">0</span>)
                </div>
                <div id="users" class="participants-grid"></div>
            </div>
        </div>
    </div>
</div>

<div id="user-info">
    <div class="user-avatar" id="user-avatar"></div>
    <span id="user-name"></span>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    let stompClient, roomId, username, owner, selectedVote;

    const scores = ["0","0.2", "0.5", "1", "1.5", "2", "2.5", "3" ,"3.5" ,"4", "4.5", "5", "8", "?"];

    // UI control functions
    function showCreateRoom() {
        document.getElementById("initial-buttons").style.display = "none";
        document.getElementById("create-room-form").style.display = "block";
        document.getElementById("join-room-form").style.display = "none";
        document.getElementById("create-username").focus();
    }

    function showJoinRoom() {
        document.getElementById("initial-buttons").style.display = "none";
        document.getElementById("create-room-form").style.display = "none";
        document.getElementById("join-room-form").style.display = "block";
        document.getElementById("join-username").focus();
    }

    function backToInitial() {
        document.getElementById("initial-buttons").style.display = "block";
        document.getElementById("create-room-form").style.display = "none";
        document.getElementById("join-room-form").style.display = "none";
    }

    // Render vote buttons dynamically
    function renderScoreButtons() {
        const container = document.getElementById("vote-buttons");
        container.innerHTML = "";
        scores.forEach(score => {
            const btn = document.createElement("button");
            btn.className = "vote-btn";
            btn.innerText = score;
            btn.onclick = () => selectVote(score, btn);
            container.appendChild(btn);
        });
    }

    function selectVote(score, btnElement) {
        document.querySelectorAll('.vote-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        btnElement.classList.add('selected');
        selectedVote = score;
        sendVote(score);
    }

    // Create room: get name from create-username input
    function createRoom() {
        const btn = event.target;
        username = document.getElementById("create-username").value.trim();
        if (!username) {
            showError("Please enter your name");
            return;
        }

        btn.classList.add('loading');
        roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
        startConnection("create");
    }

    // Join room: get name + roomId from join form inputs
    function joinRoom() {
        const btn = event.target;
        username = document.getElementById("join-username").value.trim();
        roomId = document.getElementById("join-roomId").value.trim().toUpperCase();
        if (!username || !roomId) {
            showError("Please enter your name and room ID");
            return;
        }

        btn.classList.add('loading');
        startConnection("join");
    }

    // Start websocket connection and subscribe to topic
    function startConnection(type) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/' + roomId, (message) => {
                const data = JSON.parse(message.body);
                updateParticipants(data);
                owner = data.owner;

                const isOwner = owner === username;
                document.getElementById("reveal-btn").style.display = isOwner ? "inline-flex" : "none";
                document.getElementById("reset-btn").style.display = isOwner ? "inline-flex" : "none";
            });

            // Send the initial message to server
            stompClient.send("/app/poker", {}, JSON.stringify({
                type: type,
                roomId: roomId,
                username: username
            }));

            // If creating room, join it automatically after small delay
            if (type === "create") {
                setTimeout(() => {
                    stompClient.send("/app/poker", {}, JSON.stringify({
                        type: "join",
                        roomId: roomId,
                        username: username
                    }));
                }, 100);
            }

            // Update UI: hide join/create forms, show poker UI and user info
            document.getElementById("create-room-form").style.display = "none";
            document.getElementById("join-room-form").style.display = "none";
            document.getElementById("initial-buttons").style.display = "none";

            document.getElementById("poker-area").style.display = "block";
            document.getElementById("room-name").innerText = roomId;

            document.getElementById("user-info").style.display = "flex";
            document.getElementById("user-name").innerText = username;
            document.getElementById("user-avatar").innerText = username.charAt(0).toUpperCase();

            renderScoreButtons();

            setTimeout(() => {
                document.getElementById("poker-area").classList.add('fade-in');
            }, 100);

            // Remove loading state
            document.querySelectorAll('.loading').forEach(btn => {
                btn.classList.remove('loading');
            });
        }, (error) => {
            showError("Connection failed. Please try again.");
            document.querySelectorAll('.loading').forEach(btn => {
                btn.classList.remove('loading');
            });
        });

        // Clean up websocket on page unload
        window.addEventListener("beforeunload", () => {
            if (stompClient && stompClient.connected) {
                stompClient.send("/app/poker", {}, JSON.stringify({
                    type: "leave",
                    roomId: roomId,
                    username: username
                }));
                stompClient.disconnect();
            }
        });
    }

    function sendVote(vote) {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/poker", {}, JSON.stringify({
                type: "vote",
                roomId: roomId,
                username: username,
                vote: vote
            }));
        }
    }

    function reveal() {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/poker", {}, JSON.stringify({
                type: "reveal",
                roomId: roomId,
                username: username
            }));
        }
    }

    function reset() {
        if (stompClient && stompClient.connected) {
            selectedVote = null;
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            stompClient.send("/app/poker", {}, JSON.stringify({
                type: "reset",
                roomId: roomId,
                username: username
            }));
        }
    }

    function leaveRoom() {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/poker", {}, JSON.stringify({
                type: "leave",
                roomId: roomId,
                username: username
            }));
            stompClient.disconnect();
        }
        // Reset UI to initial state
        selectedVote = null;
        document.querySelectorAll('.vote-btn').forEach(btn => btn.classList.remove('selected'));

        document.getElementById("poker-area").style.display = "none";
        document.getElementById("user-info").style.display = "none";
        backToInitial();
    }

    function updateParticipants(data) {
        document.getElementById("total").innerText = data.count;
        const users = document.getElementById("users");
        users.innerHTML = "";

        data.participants.forEach(participant => {
            const card = document.createElement("div");
            card.className = "participant-card";

            // Add special styling for owner and voted participants
            if (participant.name === owner) {
                card.classList.add('owner');
            }
            if (participant.vote && !data.revealed) {
                card.classList.add('voted');
            }

            const name = document.createElement("div");
            name.className = "participant-name";
            name.textContent = participant.name;
            if (participant.name === owner) {
                name.textContent += " 👑";
            }

            const vote = document.createElement("div");
            vote.className = "participant-vote";
            vote.textContent = data.revealed ? (participant.vote || "🤔") : (participant.vote ? "✅" : "🤔");

            card.appendChild(name);
            card.appendChild(vote);
            users.appendChild(card);
        });
    }

    function showError(message) {
        // Remove existing error messages
        document.querySelectorAll('.error-message').forEach(el => el.remove());

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;

        const activeForm = document.querySelector('#create-room-form[style*="block"], #join-room-form[style*="block"]');
        if (activeForm) {
            activeForm.insertBefore(errorDiv, activeForm.firstChild);
        }

        setTimeout(() => errorDiv.remove(), 5000);
    }

    // Ripple effect for buttons
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('btn') || e.target.classList.contains('vote-btn')) {
            const ripple = document.createElement('div');
            const rect = e.target.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;

            ripple.className = 'ripple';
            ripple.style.cssText = `
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
            `;

            e.target.style.position = 'relative';
            e.target.style.overflow = 'hidden';
            e.target.appendChild(ripple);

            setTimeout(() => ripple.remove(), 600);
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const createForm = document.getElementById('create-room-form');
            const joinForm = document.getElementById('join-room-form');

            if (createForm.style.display === 'block') {
                createRoom();
            } else if (joinForm.style.display === 'block') {
                joinRoom();
            }
        }

        if (e.key === 'Escape') {
            backToInitial();
        }
    });

    // Auto-uppercase room ID input
    document.getElementById('join-roomId').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
</script>

</body>
</html>